yum update -y
pip install awscli --upgrade --user
yum install git jq -y
yum -y install python2-pip python2 git
pip install boto3
cd /root
git clone https://github.com/aws-samples/amazon-guardduty-multiaccount-scripts.git
git clone https://github.com/awslabs/aws-securityhub-multiaccount-scripts.git
echo 'AccountId,EmailAddress' > awsaccount.csv
aws organizations list-accounts --output text --query 'Accounts[?Status==`ACTIVE`][JoinedTimestamp,Id,Email]' | sort | cut -f2- | tail -n +2 | sed -e 's/\s/,/g' >> awsaccount.csv
cp awsaccount.csv amazon-guardduty-multiaccount-scripts/
cp awsaccount.csv aws-securityhub-multiaccount-scripts/
cd amazon-guardduty-multiaccount-scripts/
python enableguardduty.py --master_account '${AWS::AccountId}' --assume_role OrganizationAccountAccessRole --enabled_regions '${AWS::Region}' ./awsaccount.csv
cd aws-securityhub-multiaccount-scripts/
python enablesecurityhub.py --master_account '${AWS::AccountId}' --assume_role OrganizationAccountAccessRole --enabled_regions '${AWS::Region}' --enable_standards arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0 ./awsaccount.csv