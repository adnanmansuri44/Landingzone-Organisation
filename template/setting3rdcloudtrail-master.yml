---
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Create Cloudtrail in Master Account'     
Parameters:
  CloudtrailName:
    Description: 'Name of Cloudtrail'
    Type: String
    Default: 'Master-Trail-DO_NOT_MODIFY'
    MinLength: '0'
    MaxLength: '64'
    AllowedPattern: "^(|[|\\w=,.@-]+)$"
    ConstraintDescription: "'Optional'The trailname must contain only upper and lowercase alphanumeric characters with no spaces. These characters are alllowed: = , . @ -" 
  TrailBucket:
    Default: cloudtrail-bucket12-MasterAccountNo
    Type: String
    Description: Enter the Cloudtrail bucket Name created in log account
  logaccountno:
    Description: 'Log AWS Account No'
    Type: Number
    MinValue: 000000000001
    MaxValue: 999999999999
    ConstraintDescription: "Enter Master Account No Only Ex:- 012345678901"   
  CloudwatchLogGroupName:
    Description: '"Optional" Name of Cloudwatch Log Group'
    Type: String
    Default: 'CloudTrail/DefaultLogGroup'
    MinLength: '0'
    MaxLength: '512'
    AllowedPattern: "[\\w-/.]+"
    ConstraintDescription: "Log group names can be between 1 and 512 characters long. Allowed characters include a-z, A-Z, 0-9, '_' (underscore), '-' (hyphen), '/' (forward slash), and '.' (period)."
  CloudWatchLogsRetentionInDays:
    Description: '"Optional" The number of days log events are kept in CloudWatch Logs'
    Type: Number
    Default: 90
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]
Conditions:
  bucketnameverify: !Equals [!Ref TrailBucket, 'cloudtrail-bucket12-MasterAccountNo']
Resources:
#---------------------------------------
#CloudTrail Configuration
#---------------------------------------                      
  TrailLogGroup:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Ref CloudwatchLogGroupName
      RetentionInDays: !Ref CloudWatchLogsRetentionInDays
  TrailLogGroupRole:
    DependsOn: TrailLogGroup
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: Cloudtrail-Cloudwatch-Loggroup
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AssumeRole1
          Effect: Allow
          Principal:
            Service: 'cloudtrail.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: 'cloudtrail-policy'
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Sid: AWSCloudTrailCreateLogStream
            Effect: Allow
            Action: logs:CreateLogStream
            Resource: !GetAtt TrailLogGroup.Arn
          - Sid: AWSCloudTrailPutLogEvents
            Effect: Allow
            Action: logs:PutLogEvents
            Resource: !GetAtt TrailLogGroup.Arn
  CloudTrailTopic:
    Type: 'AWS::SNS::Topic'
    Properties:
        DisplayName: Notify Cloudtrail Event
        TopicName: Cloudtrail-Event
  TrailTopicPolicy:
    Type: 'AWS::SNS::TopicPolicy'
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AWSCloudTrailSNSPolicy
          Effect: Allow
          Principal:
            Service: 'cloudtrail.amazonaws.com'
          Resource: !Ref CloudTrailTopic
          Action: 'sns:Publish'
      Topics:
      - !Ref CloudTrailTopic
  Trail:
    DependsOn:
    - TrailTopicPolicy
    - TrailLogGroupRole
    Type: 'AWS::CloudTrail::Trail'
    Properties:
      TrailName: !Ref CloudtrailName
      #S3BucketName: !Ref TrailBucket
      S3BucketName: !If [bucketnameverify, !Sub 'cloudtrail-bucket12-${AWS::AccountId}', !Ref TrailBucket]
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      EventSelectors:
        - 
            ReadWriteType: All
            IncludeManagementEvents: true
            DataResources: 
            - 
                Type: 'AWS::S3::Object'
                Values: 
                    -   'arn:aws:s3:::'
            -
                Type: 'AWS::Lambda::Function'
                Values:
                    -   'arn:aws:lambda'
      #KMSKeyId: !Ref myKMSKey
      KMSKeyId: 
        !Sub 
            - "arn:aws:kms:${AWS::Region}:${logaccount}:alias/Trail-Log-Encryption"
            - logaccount: !Ref logaccountno
      CloudWatchLogsLogGroupArn: !GetAtt 'TrailLogGroup.Arn'
      CloudWatchLogsRoleArn: !GetAtt 'TrailLogGroupRole.Arn'
      SnsTopicName: !GetAtt 'CloudTrailTopic.TopicName'